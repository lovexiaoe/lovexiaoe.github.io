---
title: spring-security-认证
published: true
category: spring-security
---

### 内存认证
内存认证的java配置如下：
```
@Bean
public UserDetailsService userDetailsService() throws Exception {
    // ensure the passwords are encoded properly
    UserBuilder users = User.withDefaultPasswordEncoder();
    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
    manager.createUser(users.username("user").password("password").roles("USER").build());
    manager.createUser(users.username("admin").password("password").roles("USER","ADMIN").build());
    return manager;
}
```

### JDBC认证
```
@Autowired
private DataSource dataSource;

@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    // ensure the passwords are encoded properly
    UserBuilder users = User.withDefaultPasswordEncoder();
    auth.jdbcAuthentication()
        .dataSource(dataSource)
        .withDefaultSchema()
        .withUser(users.username("user").password("password").roles("USER"))
        .withUser(users.username("admin").password("password").roles("USER","ADMIN"));
}
```

### LDAP认证
略，参考官方文档

### AuthenticationProvider
可以通过暴露一个AuthenticationProvider bean实现自定义认证，如下SpringAuthenticationProvider 实现了AuthenticationProvider，
```java
@Bean
public SpringAuthenticationProvider springAuthenticationProvider() {
    return new SpringAuthenticationProvider();
}
```

### UserDetailsService
可以通过自定义UserDetailsService来定制认证，如SpringDataUserDetailsService 实现了UserDetailsService接口，java配置如下：
```java
@Bean
public SpringDataUserDetailsService springDataUserDetailsService() {
    return new SpringDataUserDetailsService();
}
```

也可以通过PasswordEncoder 自定义密码的加密方式：
```java
@Bean
public BCryptPasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

### 密码的加密
在Spring securit5.0前，默认的PasswordEncoder 是 NoOpPasswordEncoder ，表示不加密，使用明文密码。

#### DelegatingPasswordEncoder
在使用PasswordEncoder时，只能选择一种密码加密方式，对于一些老项目或者加密方式需要变化的情况，难以处理。
这时就可以使用DelegatingPasswordEncoder。 可以使用PasswordEncoderFactories实例化DelegatingPasswordEncoder。
```java
PasswordEncoder passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();
```
或者创建自定义的实例：
```java
String idForEncode = "bcrypt";
Map encoders = new HashMap<>();
encoders.put(idForEncode, new BCryptPasswordEncoder());
encoders.put("noop", NoOpPasswordEncoder.getInstance());
encoders.put("pbkdf2", new Pbkdf2PasswordEncoder());
encoders.put("scrypt", new SCryptPasswordEncoder());
encoders.put("sha256", new StandardPasswordEncoder());
PasswordEncoder passwordEncoder = new DelegatingPasswordEncoder(idForEncode, encoders);
```
那么生成密码的格式如下，下面所有的原始密码都是password。
```
{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG
{noop}password
{pbkdf2}5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc
{scrypt}$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc/9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw==$OAOec05+bXxvuu/1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc=
{sha256}97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0
```

#### session管理
具体参考官方文档。

#### Remember-Me授权
Remember-Me实现登录，spring security提供了Hash-Based Token 和Persistent Token方式，具体参考官方文档。

